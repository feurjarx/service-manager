# Конфигурирование SSH сервиса

1 Перед настройкой ssh службы на боевом хосте необходимо сделать слуедующие действия:

1.1 Убедиться, что изначально в конфигурационном файле /service-manager/.env имеются следующие параметры (под root):
```
...
SSH_USERS=admin@adminpass,user1@user1pass,user2@user2pass
SSHD_PERMIT_ROOT_LOGIN=yes
SSHD_PASS_AUTH=yes
...
```

1.2 Всем будущим ssh-юзерам и админу сгененрировать ключи:
```
./service.sh host sshd keygen
```
Рекомендуется задавать пароль при генерации ключей. 

Важно! Название ключей должны соответствовать username'ам. 
Например, user1 должен после генерации иметь ключи:
- закрытый user1
- публичный user1.pub

1.3 Каждые ssh-юзер должен передать свой сгененнированный публичный(не закрытый!) ключ админу, 
чтобы он их поместил в каталог services/host/sshd/public-keys

2 Затем, админом запускается скрипт для установки и конфигурации всей системы (под root).
```
cd /service-manager
./service.sh host sshd deploy
./service.sh host sshd init
```
Обратите внимание! Установка происходит в соответствие с заданным окружением в файле .env
Важно! Если был определен параметр SSHD_ROOT_PASSWORD, то после выполнения данного сценария пароль root будет изменен.

3 Теперь, стоит перезапустить sshd и убедиться, что он запустился без ошибок (под root):
```
service ssh restart
```

4 Каждый ssh-юзер должен проверить возможность доступа к серверу по протоколу ssh.
Для этого необходимо убедиться, что:
4.1 на локальной машине закрытый ключ находится в каталоге ~/.ssh
4.2 в ~/.ssh имеется файл с наименованием config и подобным содержимым:
```
Host xxx.xxx.xxx.xxx
  Port 22
  User user1
  IdentityFile ~/.ssh/user1
```
где xxx.xxx.xxx.xxx - это сетевой адрес удаленного сервера.
IdentityFile указывает путь к закрытому ключу.

5 Когда все пользователи, включая админа, успешно проверили доступ к удаленному хосту, 
админ в целях безопасности должен выполнить следующий порядок действий:

5.1 Изменить окружение в файле .env, находящийся в директории /service-manager, подобным образом:
```
...
SSHD_PERMIT_ROOT_LOGIN=no
SSHD_PASS_AUTH=no
...
```
Или можно в /service-manager выполнить команды:
```
sed -i 's/SSHD_PERMIT_ROOT_LOGIN=yes/SSHD_PERMIT_ROOT_LOGIN=no/' .env
sed -i 's/SSHD_PASS_AUTH=yes/SSHD_PASS_AUTH=no/' .env
```
6.2 Применить настройки и перезапустить sshd (под root):
```
./service.sh host sshd update-sshd_config && service ssh restart
```

Обратите внимание! Теперь под root'ом логиниться запрещено и аутентификация по паролями отключена (только по ключам).


# Эмуляция боевого сервера (для тестирований)
В случае эмуляции ос пункты 2,3 будут выполнены при сборке докер образа. 
Чтобы выполнить сборку образа UNIX-ОС (debian:latest) с sshd  и затем запустить докер контейнер с данного образа,
необходимо выполнить следующие команды:
 ```
 ./service.sh docker sshd build
 ./service.sh docker sshd run
 ```
или просто:
```
./service.sh docker sshd deploy
```
Важно! Проверьте адекватность переменного окружения для сборки (.env) как описано в пунктах 1.1

Важно! Убедитесь в наличии публичных ключей перед сборкой ос (пункты 1.2-1.3).

Важно! В случае перезапуска системы контейнер будет остановлен. Потребуется его запуск (особенность работы с докер):
```
./service.sh docker sshd start
```